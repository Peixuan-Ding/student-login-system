# 数据库说明

## 📁 数据库结构

本项目使用 JSON 文件作为数据库，存储在 `database/` 目录下，由 `utils/database.js` 负责读写。

当前有效数据文件：
- `users.json`（用户与统计元数据）
- `courses.json`（课程与教学周等）
- `materials.json`（教材/资料，文件上传保存）
- `lesson-plans.json`（教案，文件上传保存）
- `resources.json`（个人知识库/资源，文件上传保存）
- `tutors.json`（学科专业导师配置与内容）

> 已移除：`chat-sessions.json`（历史会话存储不再使用）

---

### users.json — 用户数据
```json
{
  "users": [
    {
      "studentId": "12345678",    // 学号（8位数字）
      "password": "abcdef",       // 密码（6位字母）或 bcrypt 加密，以 $2 开头
      "name": "张三",             // 姓名
      "grade": "三年级",          // 年级
      "email": "zhangsan@example.com",
      "avatar": "👨‍🎓",         // 头像
      "role": "student",          // 角色
      "createdAt": "2024-01-01T00:00:00.000Z",
      "lastLogin": "2024-10-27T00:00:00.000Z",
      "isActive": true            // 是否激活
    }
  ],
  "metadata": {
    "version": "1.0.0",
    "lastUpdated": "2024-10-27T00:00:00.000Z",
    "totalUsers": 5
  }
}
```

### courses.json — 课程数据
用于课程/教学周内容（具体结构按业务扩展）。

### materials.json — 教学材料（教材/资料）
文件上传保存位置。示例结构（数组键为 `materials`）：
```json
{
  "materials": [
    {
      "id": "mat_001",                // 由后端生成，前缀 mat_
      "title": "Unit1-Reading.pdf",   // 冗余命名：title 与 name 均存
      "name": "Unit1-Reading.pdf",
      "filePath": "uploads/tmp/169...pdf", // 物理路径（如提供）
      "uploadDate": "2025-10-30T10:00:00.000Z",
      "size": 123456,                   // 可选
      "mimeType": "application/pdf"    // 可选
    }
  ]
}
```

### lesson-plans.json — 教案
文件上传保存位置。示例结构（数组键为 `lessonPlans`）：
```json
{
  "lessonPlans": [
    {
      "id": "lp_001",                 // 前缀 lp_
      "title": "七上-Unit3-教案",
      "name": "七上-Unit3-教案.docx",
      "filePath": "uploads/tmp/169...docx",
      "uploadDate": "2025-10-30T10:00:00.000Z"
    }
  ]
}
```

### resources.json — 个人知识库/资源
文件上传保存位置。示例结构（数组键为 `resources`）：
```json
{
  "resources": [
    {
      "id": "res_001",                 // 前缀 res_
      "title": "英语单词表",
      "name": "words.txt",
      "filePath": "uploads/tmp/169...txt",
      "uploadDate": "2025-10-30T10:00:00.000Z"
    }
  ]
}
```

### tutors.json — 学科专业导师
路由 `routes/tutors.js` 使用。示例结构：
```json
{
  "tutors": [
    {
      "id": "tut_1730275930000",
      "name": "英语学科导师",
      "subject": "英语",
      "goal": "提升阅读理解",
      "note": "偏向精读训练",
      "fileContext": "（可选）与任务相关的资料文本",
      "createdAt": "2025-10-30T10:00:00.000Z"
    }
  ]
}
```

---

## 🔐 默认账户

项目预设了以下测试账户：

| 学号 | 密码 | 姓名 | 年级 | 状态 |
|------|------|------|------|------|
| 12345678 | abcdef | 张三 | 三年级 | ✅ 激活 |
| 20240001 | student | 李四 | 四年级 | ✅ 激活 |
| 20240002 | test123 | 王五 | 五年级 | ✅ 激活 |
| 20240003 | demoab | 赵六 | 六年级 | ✅ 激活 |
| 20240004 | student | 小红 | 一年级 | ✅ 激活 |

---

## 📡 API 接口说明（与数据库的对应关系）

### 用户相关接口

#### 登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "studentId": "12345678",
  "password": "abcdef"
}
```

响应：
```json
{
  "success": true,
  "user": {
    "studentId": "12345678",
    "name": "张三",
    "grade": "三年级",
    ...
  }
}
```

#### 获取用户列表
```http
GET /api/users
```

#### 添加新用户
```http
POST /api/users
Content-Type: application/json

{
  "studentId": "20240005",
  "password": "passwd",
  "name": "新用户",
  "grade": "二年级",
  "email": "newuser@example.com"
}
```

#### 更新用户信息
```http
PUT /api/users/:studentId
Content-Type: application/json

{
  "name": "新名称",
  "grade": "新年级"
}
```

### 其他接口

- `GET /api/courses` - 获取课程列表
- `GET /api/materials` - 获取教学材料
- `GET /api/lesson-plans` - 获取教案
- `GET /api/resources` - 获取资源
- `GET /api/tutors` - 获取导师列表
- `POST /api/tutors` - 新增导师
- `PUT /api/tutors/:id` - 更新导师
- `DELETE /api/tutors/:id` - 删除导师

### 上传与文件保存接口（影响 materials/lesson-plans/resources）
- `POST /api/upload` - 上传文件（支持 PDF/Word/TXT/图片等），后端会解析文本用于 AI 上下文
- `POST /api/upload/save-file` - 将上传的文件信息写入数据库
  - 请求体：`{ category: 'textbook'|'materials'|'lessonPlan'|'lesson_plans'|'resource'|'resources', fileData: {...} }`
  - 数据库键映射：
    - textbook|materials → `materials`（前缀 `mat_`）
    - lessonPlan|lesson_plans → `lessonPlans`（前缀 `lp_`）
    - resource|resources → `resources`（前缀 `res_`）
- `DELETE /api/upload/delete-file/:category/:fileId` - 从数据库删除记录，并尝试删除物理文件
- `POST /api/upload/upload/cleanup` - 清理临时上传文件

---

## 🛠️ 使用指南

### 1. 启动服务器
```bash
npm start
```
服务器将运行在 `http://localhost:3000`

### 2. 测试登录
访问 `http://localhost:3000`
使用账户：`12345678` / `abcdef`

### 3. 管理用户
#### 添加新用户
可以直接编辑 `database/users.json` 或使用 API 接口添加。

#### 修改用户信息
```bash
# 直接编辑 users.json 文件
# 或使用 API 接口
```

---

## ⚠️ 注意事项

1. **密码安全**: `users.json` 包含明文密码，不要提交到公开仓库
2. **数据备份**: 定期备份 `database/` 目录下的所有文件
3. **并发控制**: 当前实现不支持并发写入，在高并发场景下需要改进
4. **性能考虑**: 如果用户量很大，建议迁移到真实的数据库（MySQL、PostgreSQL等）

---

## 🔄 数据迁移

### 从硬编码迁移到数据库
项目已经从 `script.js` 中的硬编码用户数据库迁移到 JSON 文件数据库，所有用户数据现在存储在 `database/users.json`。

### 备份数据
```bash
# 备份整个数据库目录
cp -r database database_backup_$(date +%Y%m%d)
```

### 恢复数据
```bash
# 恢复备份
cp -r database_backup_20241027 database
```

---

## 📈 扩展建议

### 升级到真实数据库

如果项目需要扩展，建议升级到以下方案之一：

#### 方案1: SQLite
```bash
npm install better-sqlite3
```
适合轻量级应用，单文件数据库。

#### 方案2: MongoDB
```bash
npm install mongodb mongoose
```
适合文档型数据，灵活易扩展。

#### 方案3: PostgreSQL/MySQL
```bash
npm install pg mysql2
```
适合复杂查询和高性能需求。

---

## 🐛 故障排除

### 问题：用户无法登录
- 检查服务器是否运行
- 检查 `database/users.json` 是否存在
- 检查 JSON 格式是否正确

### 问题：数据丢失
- 从备份恢复
- 检查 `.gitignore` 是否排除了数据库文件

### 问题：文件权限错误
```bash
# Linux/Mac
chmod -R 755 database/

# Windows (PowerShell)
icacls database /grant Users:F
```

---

## 📞 技术支持

如有问题，请检查：
1. 服务器日志
2. 浏览器控制台
3. 数据库文件完整性


