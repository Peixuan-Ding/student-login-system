# 快速部署指南 - 云服务器

本文档说明如何将文件上传功能部署到云服务器。

## 📋 部署前准备

### 必需信息
- ✅ 云服务器 IP 地址
- ✅ 服务器 SSH 访问权限
- ✅ GitHub 仓库已更新（已完成 ✅）

### 服务器要求
- Node.js 18+
- PM2 已安装
- 端口 3000 已开放

---

## 🚀 快速部署

### 方法一：使用自动化脚本（推荐）

#### Windows 用户

```powershell
# 1. 打开 PowerShell
cd "D:\Ding\STT platform"

# 2. 运行部署脚本
.\deploy-to-server.ps1

# 3. 按提示输入服务器信息
#    - 服务器 IP
#    - 用户名（默认 root）
#    - 部署目录
```

#### Linux/Mac 用户

```bash
# 1. 添加执行权限
chmod +x deploy-to-server.sh

# 2. 运行部署脚本
./deploy-to-server.sh

# 3. 按提示输入服务器信息
```

### 方法二：手动部署

#### 1️⃣ 连接到服务器

```bash
ssh root@你的服务器IP
```

#### 2️⃣ 进入项目目录

```bash
cd /root/student-login-system
```

#### 3️⃣ 拉取最新代码

```bash
git pull origin main
```

#### 4️⃣ 安装新依赖

```bash
# 检查是否需要安装新包
npm install
```

如果有新增依赖，需要安装：
```bash
npm install multer pdf-parse mammoth
```

#### 5️⃣ 创建上传目录

```bash
mkdir -p uploads/tmp
chmod 755 uploads/tmp
```

#### 6️⃣ 重启服务

```bash
pm2 restart STT-Learning-Platform
```

#### 7️⃣ 检查状态

```bash
pm2 status
pm2 logs STT-Learning-Platform
```

---

## 🔍 部署验证

### 1. 检查服务运行状态

```bash
# 在服务器上执行
pm2 list
curl http://localhost:3000
```

### 2. 测试文件上传功能

1. 访问 `http://你的服务器IP:3000`
2. 登录系统
3. 进入"学科专业导师"界面
4. 点击 📎 图标上传文件
5. 尝试上传 PDF 或 Word 文档
6. 提问并查看导师回答

### 3. 查看日志

```bash
# 实时查看日志
pm2 logs STT-Learning-Platform --lines 100

# 查看错误日志
pm2 logs STT-Learning-Platform --err

# 查看启动日志
pm2 describe STT-Learning-Platform
```

---

## ⚙️ 配置检查

### 确保环境变量正确

检查服务器上的 `config.json`：

```bash
cat config.json
```

应该包含：
```json
{
  "deepseek": {
    "baseUrl": "https://api.deepseek.com",
    "apiKey": "your_api_key_here"
  }
}
```

### 确保依赖已安装

```bash
npm list multer pdf-parse mammoth
```

如果没有安装，运行：
```bash
npm install multer pdf-parse mammoth
```

---

## 🐛 故障排查

### 问题1: 文件上传失败

**症状**: 上传文件后没有响应

**排查**:
```bash
# 检查上传目录
ls -la uploads/tmp

# 检查权限
chmod 755 uploads/tmp

# 查看错误日志
pm2 logs --err
```

**解决**: 确保 `uploads/tmp` 目录存在且有写权限

### 问题2: 文本提取失败

**症状**: 上传文件后提示"文本提取失败"

**排查**:
```bash
# 检查是否安装了必要依赖
npm list pdf-parse mammoth

# 如果没有，安装它们
npm install pdf-parse mammoth
```

### 问题3: 服务无法访问

**症状**: 浏览器无法访问服务器

**排查**:
```bash
# 检查服务是否运行
pm2 list

# 检查端口占用
netstat -tulpn | grep 3000

# 检查防火墙
ufw status
```

**解决**:
```bash
# 如果服务未运行
pm2 start ecosystem.config.js --env production

# 如果端口被占用
pm2 restart STT-Learning-Platform

# 如果防火墙未开放
ufw allow 3000
```

---

## 📊 部署后检查清单

- [ ] 代码已从 GitHub 拉取
- [ ] 新依赖已安装（multer, pdf-parse, mammoth）
- [ ] uploads/tmp 目录已创建
- [ ] 服务已重启
- [ ] 可以通过浏览器访问
- [ ] 可以上传文件
- [ ] 文本提取功能正常
- [ ] AI 问答功能正常

---

## 🔄 更新流程

当有新功能需要部署时：

```bash
# 1. 本地提交到 GitHub（已完成）
git add .
git commit -m "描述"
git push origin main

# 2. 在服务器上更新
ssh root@你的服务器IP
cd /root/student-login-system
git pull origin main
npm install
pm2 restart STT-Learning-Platform

# 3. 验证
pm2 logs STT-Learning-Platform
```

---

## 💡 最佳实践

### 1. 备份数据

部署前备份重要数据：

```bash
# 备份数据库
tar -czf backup-$(date +%Y%m%d).tar.gz database/

# 备份配置文件
cp config.json config.json.backup
```

### 2. 测试环境

建议先在测试服务器上验证，再部署到生产环境。

### 3. 监控日志

部署后持续监控日志至少 10 分钟：

```bash
pm2 logs STT-Learning-Platform --lines 100 --raw
```

### 4. 渐进式部署

- 先部署到小范围测试
- 确认无问题后再全量部署
- 保留回滚方案

---

## 📞 需要帮助？

如果遇到问题，请提供以下信息：

1. 服务器日志：`pm2 logs STT-Learning-Platform`
2. 错误信息截图
3. 复现步骤
4. 服务器环境信息：`node -v && npm -v && pm2 -v`

---

## ✨ 部署完成

恭喜！您的文件上传功能已成功部署到云服务器！

现在可以：
- ✅ 上传 PDF 文件
- ✅ 上传 Word 文档
- ✅ 上传文本文件
- ✅ 获得基于文件内容的 AI 回答

享受学习之旅！🎉

