# 文件上传功能说明

## 功能概述

学科专业导师界面现已支持真实文件上传功能。用户可以上传 PDF、Word 文档和文本文件，系统会自动提取文件内容，并使用 DeepSeek API 根据文件内容回答用户的问题。

## 主要改进

### 1. 后端实现

#### 新增文件处理工具 (`utils/fileProcessor.js`)
- 支持 PDF、Word、TXT 文件的文本提取
- 使用 `pdf-parse` 提取 PDF 内容
- 使用 `mammoth` 提取 Word 文档内容
- 批量处理多个文件

#### 新增文件上传路由 (`routes/upload.js`)
- 文件上传接口：`POST /api/upload`
- 支持多文件上传（最多 10 个文件）
- 文件大小限制：10MB
- 自动提取文件文本内容

#### 修改 AI 路由 (`routes/ai.js`)
- 支持 `fileContext` 参数
- 将文件内容添加到系统提示词
- 智能融合本地知识库和上传文件内容

### 2. 前端实现

#### 更新文件上传功能 (`public/learning-platform.js`)
- 更新 `confirmFileUpload()` 函数，实现真实文件上传
- 添加 `showUploadedFilesBadge()` 函数，显示已上传文件
- 添加 `removeUploadedFile()` 函数，支持移除已上传文件
- 更新 `callMyTutorAPI()` 函数，集成文件内容到 AI 对话

#### 新增全局变量
- `window.uploadedFilesContext`: 存储提取的文件文本
- `window.uploadedFiles`: 存储文件信息列表

## 使用流程

1. **用户点击上传按钮** → 选择文件
2. **前端上传文件** → 发送到 `/api/upload`
3. **后端处理文件** → 提取文本内容
4. **返回提取结果** → 显示已附加文件标签
5. **用户提问** → 将文件内容加入系统提示词
6. **调用 DeepSeek API** → 基于文件内容回答问题

## 技术细节

### 文件上传流程
```
前端 (FormData) 
  ↓
后端 (multer) 
  ↓
文件存储 (uploads/tmp/)
  ↓
提取文本 (pdf-parse/mammoth)
  ↓
返回提取结果
  ↓
前端保存到 window.uploadedFilesContext
```

### AI 对话流程
```
用户问题 + 文件内容
  ↓
构建系统提示词
  ↓
调用 DeepSeek API (/api/deepseek/chat)
  ↓
返回基于文件内容的回答
```

## 配置要求

### 环境变量
```bash
DEEPSEEK_API_KEY=your_api_key
```

### config.json
```json
{
  "deepseek": {
    "baseUrl": "https://api.deepseek.com",
    "apiKey": "your_api_key"
  }
}
```

## 依赖包

新增依赖：
- `multer`: 文件上传处理
- `pdf-parse`: PDF 文本提取
- `mammoth`: Word 文档文本提取

安装命令：
```bash
npm install multer pdf-parse mammoth
```

## 文件结构

```
STT platform/
├── routes/
│   ├── upload.js          # 文件上传路由
│   └── ai.js              # AI 路由（已更新）
├── utils/
│   └── fileProcessor.js   # 文件处理工具
├── uploads/               # 上传文件存储目录
│   └── tmp/               # 临时文件
└── public/
    └── learning-platform.js  # 前端代码（已更新）
```

## 测试建议

1. **功能测试**：
   - 上传 PDF 文件
   - 上传 Word 文档
   - 上传 TXT 文本
   - 多文件上传
   - 移除已上传文件

2. **边界测试**：
   - 上传超过 10MB 的文件
   - 上传不支持的文件类型
   - 上传损坏的文件
   - 上传空文件

3. **性能测试**：
   - 上传大型 PDF 文件
   - 上传多个文件
   - 长文本内容处理

## 已知限制

1. **图片文件**：仅支持上传，不支持文本提取
2. **扫描版 PDF**：无法提取文本内容
3. **文件持久化**：服务器重启后文件丢失
4. **Token 限制**：大量文件可能超出 API token 限制

## 后续优化

- [ ] 添加文件持久化存储
- [ ] 支持更多文件格式
- [ ] 添加图片 OCR 识别
- [ ] 实现文件预览功能
- [ ] 添加文件搜索功能
- [ ] 优化大型文件处理性能

