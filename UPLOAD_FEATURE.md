# 文件上传功能使用指南

## 功能概述

学科专业导师界面现已支持真实文件上传功能。用户可以上传 PDF、Word 文档和文本文件，系统会自动提取文件内容，并使用 DeepSeek API 根据文件内容回答用户的问题。

## 支持的文件类型

- **PDF 文件** (.pdf)
- **Word 文档** (.doc, .docx)
- **文本文件** (.txt)

**注意**：图片文件目前不支持文本提取，仅支持上传。

## 使用步骤

### 1. 上传文件

1. 进入"学科专业导师"页面
2. 点击输入框左侧的回形针图标 📎
3. 在弹窗中选择"新上传"标签
4. 拖拽文件到上传区域，或点击"选择文件"按钮
5. 可以同时选择多个文件（最多 10 个）
6. 点击"确认"按钮上传文件

### 2. 文件处理

- 系统会自动提取文件中的文本内容
- 文件内容会被暂时保存在内存中，用于回答后续问题
- 上传成功后，会显示已附加的文件列表

### 3. 向导师提问

1. 在输入框中输入您的问题
2. 点击发送按钮或按 Enter 键
3. 导师会基于上传的文件内容和本地知识库回答您的问题

### 4. 管理已附加的文件

- 在输入框上方会显示已附加文件的标签
- 点击文件标签右侧的 ❌ 按钮可以移除该文件
- 移除文件后，后续问题将不再基于该文件的内容

## 技术实现

### 后端

- **文件上传路由**：`/api/upload`
  - 使用 `multer` 处理文件上传
  - 支持多文件上传（最多 10 个）
  - 文件大小限制：10MB

- **文件处理**：`utils/fileProcessor.js`
  - 使用 `pdf-parse` 提取 PDF 文本
  - 使用 `mammoth` 提取 Word 文档文本
  - 支持文本文件直接读取

### 前端

- **文件上传**：`confirmFileUpload()` 函数
  - 将文件通过 FormData 发送到后端
  - 显示上传进度
  - 保存提取的文本内容到 `window.uploadedFilesContext`

- **AI 调用**：`callMyTutorAPI()` 函数
  - 将文件内容添加到系统提示词中
  - 使用 DeepSeek API 回答问题
  - 增加 max_tokens 到 2000 以处理更多内容

### DeepSeek API 集成

- **路由**：`/api/deepseek/chat`
- **参数**：
  - `fileContext`: 提取的文件文本内容
  - `messages`: 对话消息列表
  - `temperature`: 0.7
  - `max_tokens`: 2000

## 文件存储

- 上传的文件存储在 `uploads/tmp/` 目录
- 文件采用时间戳 + 随机数命名，避免冲突
- 建议定期清理临时文件（目前未自动清理）

## 注意事项

1. **文件大小限制**：单个文件最大 10MB
2. **文件数量限制**：每次最多上传 10 个文件
3. **API 限制**：大量文本内容可能超出 DeepSeek API 的 token 限制
4. **隐私安全**：上传的文件仅用于本次会话，服务器重启后会丢失
5. **性能考虑**：大型 PDF 文件处理可能需要较长时间

## 故障排查

### 上传失败

- 检查文件大小是否超过 10MB
- 检查文件类型是否支持
- 查看浏览器控制台错误信息

### 文本提取失败

- 检查文件是否为扫描版 PDF（无文本层）
- 检查文件是否损坏
- 某些 Word 文档格式可能不支持

### API 调用失败

- 检查 `config.json` 中的 DeepSeek API 密钥是否正确
- 检查网络连接
- 查看服务器日志

## 未来改进

- [ ] 添加文件预览功能
- [ ] 支持更多文件格式（Excel、PPT 等）
- [ ] 添加文件历史记录
- [ ] 实现文件持久化存储
- [ ] 添加文件搜索功能
- [ ] 支持图片 OCR 识别

